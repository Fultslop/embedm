# Toc Plugin

version 0.8.0

The toc plugin generates a table of contents from the headings in the compiled document. It scans all content from its position forward — including headings embedded from other files — and produces either a plain bullet list or a clickable list of anchor links.

  - [Basic Usage](#basic-usage)
  - [Clickable Entries](#clickable-entries)
    - [Slug Generation](#slug-generation)
  - [Limiting Depth](#limiting-depth)
  - [Duplicate Headings](#duplicate-headings)
  - [Plugin Sequence](#plugin-sequence)
  - [start_fragment](#start-fragment)

## Basic Usage

Place a `type: toc` directive anywhere in your document. Without options it scans every heading that follows the directive (up to H5 by default) and produces a flat bullet list:

```yaml
type: toc
```

The table of contents above this section was generated exactly this way, with `add_slugs: True` added to produce clickable links. See [Clickable Entries](#clickable-entries) below.

## Clickable Entries

Set `add_slugs: True` to generate GitHub-compatible anchor links for each entry:

```yaml
type: toc
add_slugs: True
```

The table of contents at the top of this page is a live example.

### Slug Generation

Slugs are generated by lowercasing the heading text, stripping non-alphanumeric characters (except hyphens), and replacing runs of whitespace or underscores with a single hyphen. This matches the algorithm used by GitHub Markdown renderers, so links work in rendered `.md` files without any extra configuration.

## Limiting Depth

Use `max_depth` to control how many heading levels are included. The default is 5 (H1 through H5). Setting `max_depth: 2` limits output to H1 and H2 entries only.

The example below uses `start_fragment: 0` to scan from the beginning of this document, so you can see depth filtering in action across the full heading tree:

```yaml
type: toc
start_fragment: 0
max_depth: 2
```

- Toc Plugin
  - Basic Usage
  - Clickable Entries
  - Limiting Depth
  - Duplicate Headings
  - Plugin Sequence
  - start_fragment

Without `max_depth`, the same scan with default depth (5) produces:

```yaml
type: toc
start_fragment: 0
```

- Toc Plugin
  - Basic Usage
  - Clickable Entries
    - Slug Generation
  - Limiting Depth
  - Duplicate Headings
  - Plugin Sequence
  - start_fragment

## Duplicate Headings

When two or more headings share the same text, the slug for each duplicate is suffixed with a counter (`-1`, `-2`, …) to keep anchors unique. This matches the behaviour of GitHub Markdown renderers.

For example, three headings all reading `Setup` would produce slugs `setup`, `setup-1`, and `setup-2`. Plain lists (without `add_slugs`) are not affected.

## Plugin Sequence

The toc plugin must run after the plugins that produce content. If it ran early, any headings brought in by the file plugin or query-path plugin would not yet be part of the compiled document and would be invisible to the TOC scanner.

Place `embedm_plugins.toc_plugin` last (or near-last) in `plugin_sequence` in your `embedm-config.yaml`:

```yaml
plugin_sequence:
  - embedm_plugins.file_plugin
  - embedm_plugins.query_path_plugin
  - embedm_plugins.table_plugin
  - embedm_plugins.synopsis_plugin
  - embedm_plugins.toc_plugin
```

The toc plugin reads from `parent_document`, the sequence of compiled fragments that make up the document at transform time. It skips headings inside fenced code blocks, so headings in code examples are never included.

## start_fragment

By default the toc scans forward from the position of the directive itself — headings that appear before it in the source are not included. Set `start_fragment: 0` to scan the entire document from the beginning, regardless of where the directive is placed.

```yaml
type: toc
start_fragment: 0
add_slugs: True
```

The value is a zero-based index into the compiled fragment list. The default of `-1` is a sentinel that tells the plugin to resolve the directive's own position automatically.
